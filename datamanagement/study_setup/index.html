<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Team Brawndo" />
  <title>CBBS Imaging &ndash; Initial Study Setup</title>
  <link rel="license" hreflang="en" href="../../copyright.html" />

  <link rel="stylesheet" type="text/css" href="../../theme/css/style.css">
</head>

<body>
  <aside>
    <h1><a href="/">CBBS Imaging</a></h1>
    <nav>
      <ul>

              <li>
                <a href="../../datamanagement/">Data Management</a>

                <ul>
                  <li>
                    <a class="active" href="../../datamanagement/study_setup/">Initial Study Setup</a>
<div id="toc"><ul><li><a class="toc-href" href="#overview" title="Overview">Overview</a><ul><li><a class="toc-href" href="#preparation" title="Preparation">Preparation</a></li><li><a class="toc-href" href="#dataset creation" title="Dataset creation">Dataset creation</a></li></ul></li><li><a class="toc-href" href="#step-by-step demo_1" title="Step-by-step demo">Step-by-step demo</a><ul><li><a class="toc-href" href="#creating a raw dataset" title="Creating a raw dataset">Creating a raw dataset</a></li><li><a class="toc-href" href="#acquiring data" title="Acquiring data">Acquiring data</a></li></ul></li></ul></div>                  </li>
                  <li>
                    <a href="../../datamanagement/study_specification/">Study Metadata</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_dicoms/">DICOM Data</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_other/">Non-DICOM Data</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/conversion/">BIDS Conversion</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/tools/">Tools</a>
                  </li>
                </ul>
              </li>
              <li><a href="../../analysis/">Data Analysis</a></li>
              <li><a href="../../devices/">Acquisition Hardware</a></li>
              <li><a href="../../containers/">Computational Environments</a></li>
              <li><a href="../../contributing/">Contributing</a></li>
      </ul>
    </nav>
    <form class="searchbox" action="../../search.html">
      <input type="text" name="q" id="tipue_search_input" placeholder="Search">
    </form>
    <img src="../../theme/img/cbbs_logo.png" alt="CBBS Logo">
    <img src="../../theme/img/EFRE_logo.png"
         alt="Signets of Saxony-Anhalt and the European Regional Development Fund">
  </aside>

  <main>
    <div id='content'>
<article>
  <header>
    <nav>
      <ul class="breadcrumbs">
        <li><a href="../../">Home</a></li>
        <li> > <a href="../../datamanagement/">Data Management</a></li>
        <li> > Initial Study Setup</li>
      </ul>
    </nav>
    <h1>Initial Study Setup</h1>
  </header>

  <div>
    <div class="section" id="overview">
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permalink to this headline"><i class="icon-link"></i></a></h2>
<p>A study raw dataset contains all raw data and metadata on a study, across
all acquisitions and participants. It is typically created just prior the
first (pilot) acquisition.  Its purpose is to record all data in their raw,
unaltered form, as provided by the respective acquisition machinery.
Moreover, it is used to bind data from multiple acquisition sources (e.g.
MRI, eye tracker, ECG) together, to create a reliable record of what data
were recorded at which point on what hardware. Importantly, this also includes
the logs of any stimulation setup, or behavior responses that are typically
generated by paradigm implementations provided by individual researchers.</p>
<p><em>The study raw dataset should capture all information required to reproduce
any subsequently performed data analyses.</em></p>
<p>A study raw dataset is supposed to have a subdirectory for each acquisition. The
name of this directory is the acquisition identifier as far as the tools
described here are concerned. Each of those acquisition directories should
contain all relevant data of an acquisition. Most notably they contain a
subdataset <cite>dicoms</cite> and a <a class="reference external" href="../../datamanagement/study_specification/">specification file</a>
to curate required information for <a class="reference external" href="../../datamanagement/conversion/">conversion</a> . It
is recommended to group other data according to its source and nature similarly
(i.e. have a <cite>physio</cite> subdirectory alongside the <cite>dicoms</cite> subdirectory).
The study raw dataset should also contain custom code needed for conversion in
order to provide reproducibility.</p>
<div class="section" id="preparation">
<h3 id="preparation">Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline"><i class="icon-link"></i></a></h3>
<p>Data management relies on <a class="reference external" href="https://github.com/datalad/datalad">datalad</a> and
<a class="reference external" href="https://github.com/psychoinformatics-de/datalad-hirni">datalad-hirni</a>
respectively, which is an extension to datalad to provide additional
functionality for this platform.
Start off by <a class="reference external" href="https://github.com/psychoinformatics-de/datalad-hirni#installation">installing datalad-hirni</a>.</p>
</div>
<div class="section" id="dataset-creation">
<h3 id="dataset creation">Dataset creation<a class="headerlink" href="#dataset-creation" title="Permalink to this headline"><i class="icon-link"></i></a></h3>
<p>To create a study dataset you just need to run:</p>
<pre class="literal-block">
datalad rev-create [TARGET-DIR]
</pre>
<p>If you don't provide a target dir, the dataset will be created in the current
working directory. This will create an empty datalad dataset.</p>
<p>To preconfigure it to be a <em>study dataset</em> however, you need to run a dedicated
setup procedure from within the dataset:</p>
<pre class="literal-block">
cd [TARGET-DIR]
datalad run-procedure setup_hirni_dataset
</pre>
<p>This command will do several things to make this a study dataset.
Apart from setting some configurations like enabling the extraction of DICOM metadata, it will create a default README file, a dataset_description.json template file, an initial study specification file and it will install hirni's <a class="reference external" href="../../datamanagement/tools/toolbox/">toolbox dataset</a> as a subdataset of <cite>my_raw_dataset</cite>.
Note, that by default the toolbox is installed from github. If you need to install from elsewhere, you can set the <cite>datalad.hirni.toolbox.url</cite> config to point to another URL prior to running <tt class="docutils literal">setup_hirni_dataset</tt>.</p>
<dl class="docutils">
<dt>You can now use hirni's <a class="reference external" href="../../datamanagement/tools/webui/">webUI</a> to edit the study metadata and thereby fill the <tt class="docutils literal">dataset_description.json</tt> file.</dt>
<dd>This step can be postponed or repeated later on to complete it. There's no technical need to fill it out completely (or at all) at this point. It is recommended to do it as far as you can though.</dd>
</dl>
<p>The dataset is now ready for <a class="reference external" href="../../datamanagement/import_dicoms/">importing</a> acquisition data.</p>
</div>
</div>
<div class="section" id="step-by-step-demo">
<h2 id="step-by-step demo_1">Step-by-step demo<a class="headerlink" href="#step-by-step-demo" title="Permalink to this headline"><i class="icon-link"></i></a></h2>
<p>This is a simple example showing how to create a study dataset with datalad-hirni
and how to import data into such a dataset. The raw data we use for this demo is publicly available from two example repositories at github.
For reference what this data is about, simply visit <a class="reference external" href="https://github.com/datalad/example-dicom-functional/">https://github.com/datalad/example-dicom-functional/</a>
and <a class="reference external" href="https://github.com/datalad/example-dicom-structural/">https://github.com/datalad/example-dicom-structural/</a> in your browser. For all commands to work in the exact form shown here, create a directory for that demo first and switch into it:</p>
<pre class="literal-block">
% mkdir demo
% cd demo
</pre>
<div class="section" id="creating-a-raw-dataset">
<h3 id="creating a raw dataset">Creating a raw dataset<a class="headerlink" href="#creating-a-raw-dataset" title="Permalink to this headline"><i class="icon-link"></i></a></h3>
<p>First off, we need a study raw dataset to bundle all raw data in a structured way:</p>
<pre class="literal-block">
% datalad rev-create my_raw_dataset
% cd my_raw_dataset
% datalad run-procedure setup_hirni_dataset
</pre>
<p>The first command will create a datalad dataset with nothing special about it. The last, however, runs a hirni procedure, that will do several things to make this a study dataset.
Apart from setting some configurations like enabling the extraction of DICOM metadata, it will create a default README file, a dataset_description.json template file, an initial study specification file and it will install hirni's <a class="reference external" href="../../datamanagement/tools/toolbox/">toolbox dataset</a> as a subdataset of <cite>my_raw_dataset</cite>.
Note, that by default the toolbox is installed from github. If you need to install from elsewhere, you can set the <cite>datalad.hirni.toolbox.url</cite> config to point to another URL prior to running <tt class="docutils literal">setup_hirni_dataset</tt>.
It now should like this:</p>
<pre class="literal-block">
% tree -L 2
.
├── code
│&nbsp;&nbsp; └── hirni-toolbox
├── dataset_description.json
├── README
└── studyspec.json
</pre>
<p>And from a datalad perspective like this:</p>
<pre class="literal-block">
% datalad ls -r
.                    [annex]  master  ✗ 2019-02-28/12:37:01  ✓
code/hirni-toolbox   [annex]  master  ✗ 2019-02-27/21:23:59  ✓
</pre>
<p>We now have an initial study dataset and should start by editing the study metadata, which is stored in <cite>dataset_description.json</cite>. For convenience when doing this manually we can use hirni's web UI:</p>
<pre class="literal-block">
% datalad webapp --dataset . hirni
</pre>
<p>The output following this command should end reading <cite>Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</cite>.
Now this address can be opened in a browser and should look like this:</p>
<img alt="" src="/theme/img/webui_index.png"/>
<p>Choose "Edit study metadata" (we have no acquisition yet) to get to this form:</p>
<img alt="" src="/theme/img/webui_edit_study.png"/>
<p>It's not required to fill this at this point (technically it's not required to be filled at any point), but generally recommended to record whatever information you have ASAP into that dataset. Its recorded history is just as useful as you allow it to be.</p>
</div>
<div class="section" id="acquiring-data">
<h3 id="acquiring data">Acquiring data<a class="headerlink" href="#acquiring-data" title="Permalink to this headline"><i class="icon-link"></i></a></h3>
<p>Now, we want the actual data. To import a DICOM tarball into the study dataset, there is a dedicated hirni command <cite>hirni-import-dcm</cite>.
This will add the DICOMS to our dataset, extract metadata from their headers and derive a specification for each series it finds in those DICOM files.
A hirni study dataset is supposed to put all data of each acquisition into a dedicated subdirectory, which also contains a specification file for that acquisition.
We can give the command a name for such an acquisition or let it try to derive one from what it finds in the DICOM headers. Everything that is automatically concluded from the metadata can be overwritten by options to that command, of course.
Something that can't automatically be derived, of course, are anonymized subject identifiers. This association will be needed for anonymized conversion. You can add those IDs later, of course, but we can do it right from the start via the option <cite>--anon-subject</cite>.
<cite>datalad hirni-import-dcm</cite> can import such tarballs either from a local path or an URL. For this demo we use the above mentioned example data available from github:</p>
<pre class="literal-block">
% datalad hirni-import-dcm --anon-subject 001 https://github.com/datalad/example-dicom-structural/archive/master.tar.gz acq1
</pre>
<p>This should create a new acquisition directory <cite>acq1</cite>, containing a <cite>studyspec.json</cite> and a subdataset <cite>dicoms</cite>.
Note, that this subdataset contains the original tarball itself (in a hidden way) and the extracted DICOMS. As long as we don't need to operate on the DICOM files, we don't really them to be there. We can throw their content away by calling:</p>
<pre class="literal-block">
% datalad drop acq1/dicoms/*
</pre>
<p>This should result in the DICOM files having no content. We can get them again any time via <cite>datalad get acq1/dicoms/*</cite>.
Import the second acquisition the same way:</p>
<pre class="literal-block">
% datalad hirni-import-dcm --anon-subject 001 https://github.com/datalad/example-dicom-functional/archive/master.tar.gz acq2
</pre>
<p>Note, that this imports and extracts metadata from about 6000 DICOM files. It will take a few minutes.
This time we have something else to import for that acquisition: the events file. Generally, you can add arbitrary files to the dataset. Protocols, logfiles, physiological data, code - it is meant to bundle all raw data of study.
The functional data already provides an events.tsv file and therefore we can find it already in the <cite>dicoms</cite> subdataset we just created. Since such a file is usually not included in a DICOM tarball you'd start with, lets pretend it's not actually in that archive and import it separately again.
We use <cite>git annex addurl</cite> to retrieve that file and then save the new state of our dataset by calling <cite>datalad rev-save</cite>:</p>
<pre class="literal-block">
% git annex addurl https://github.com/datalad/example-dicom-functional/raw/master/events.tsv --file acq2/events.tsv
% datalad rev-save --message "Added stimulation protocol for acquisition 2"
</pre>
<p class="note"><strong>NOTE:</strong> The calls to <cite>git annex addurl</cite> and <cite>datalad rev-save</cite> currently replace a single call to <cite>datalad download-url</cite> due to a bug in that command.</p>
<p>Please note, that the choice where exactly to put such a file within an acquisition directory is entirely up to you. datalad-hirni doesn't expect any particular structure within an acquisition. As long as the specification files are correctly referencing the locations of the data, everything is fine.
Now, for a later conversion there is no general conversion rule for tsv files. We need to tell the system what it is supposed to do with that file (if anything) on conversion. For that, we add a specification for that file using <cite>hirni-spec4anything</cite>.
This command allows to add (or replace) a specification for arbitrary things. By default it will generate a specification that already "inherits" everything, that is unambiguously uniform in the existing specifications of that acquisition.
That means, if our automatically created specification for the functional DICOMs managed to derive all required BIDS terms (in this case it's about "subject", "task" and "run") and their values for the dicomseries, <cite>spec4anything</cite> will use that as well for the new specification (except we overrule this).
So, all we need to do here, is to specify a conversion routine. For correct BIDS conversion we only need to copy that file to its correct location. Such a "copy-converter" is provided by the toolbox we have installed at the beginning.
Editing or adding such a specification is again possible via the webUI. For the purpose of this demo, however, we will this time use the command line to show how that looks like:</p>
<pre class="literal-block">
% datalad hirni-spec4anything acq2/events.tsv --properties '{"procedures": {"procedure-name": "copy-converter", "procedure-call": "bash {script} {{location}} {ds}/sub-{{bids-subject}}/func/sub-{{bids-subject}}_task-{{bids-task}}_run-{{bids-run}}_events.tsv"}, "type": "events_file"}'
</pre>
<p>What we pass here into the <cite>properties</cite> option is a JSON string. This is the underlying structure of what you can see in the webUI. The necessary quoting/escaping at the command line is admittedly not always easy for manual editing.
Note, that instead of such a string you can also pass a path to JSON file. (and more generally: All of datalad and the datalad-hirni extension is accessible via a Python API as well)
For a more extensive description of the specification (and therefore those <cite>properties</cite>) see the <a class="reference external" href="../../datamanagement/study_specification/">specification page</a>.</p>
<p>If you ran all the commands in this demo the exact same way as posted, your dataset should now look exactly like this: <a class="reference external" href="https://github.com/psychoinformatics-de/hirni-demo">https://github.com/psychoinformatics-de/hirni-demo</a>
For comparison you can examine it on github or install it locally to have a closer look via:</p>
<pre class="literal-block">
% cd ..
% datalad install -s https://github.com/psychoinformatics-de/hirni-demo --recursive
</pre>
<p>We now bound all information on that study and its acquisitions in its native, absolutely unmodified form together in a dataset that can now serve as a starting point for any kind of processing.
This dataset is much less likely to suffer from software bugs than a ready-to-analyze dataset with NIfTIs etc, but the software stack that actually touched the data files is minimal.</p>
</div>
</div>

  </div>
</article>
    </div>

    <footer>
      <p><small>
          Acknowledgment: funded by the federal state of Saxony-Anhalt and the "European Regional Development Fund" (ERDF 2014-2020), Project: Center for Behavioral Brain Sciences (CBBS), FKZ: ZS/2016/04/78113
      </small></p>
      <p><small>
        content licensed <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">cc-by-sa</a>
        <span class='break'>—</span> ©2017–2018 Team Brawndo <span class='break'>—</span>
        unless <a rel="license" href='../../copyright.html'>indicated otherwise</a>
      </small></p>
    </footer>
  </main>
</body>
</html>