<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Team Brawndo" />
  <title>CBBS Imaging &ndash; Demo: DICOM DB</title>
  <link rel="license" hreflang="en" href="../../copyright.html" />

  <link rel="stylesheet" type="text/css" href="../../theme/css/style.css">
</head>

<body>
  <aside>
    <h1><a href="/">CBBS Imaging</a></h1>
    <nav>
      <ul>

              <li>
                <a href="../../datamanagement/">Data Management</a>

                <ul>
                  <li>
                    <a href="../../datamanagement/study_setup/">Initial study setup</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_dicoms/">Import DICOMs</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_other/">Import additional data</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/study_specification/">Study specification</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/conversion/">Raw Data Conversion</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/demo/">Demo Study</a>
                  </li>
                  <li>
                    <a class="active" href="../../datamanagement/demo_scandb/">Demo: DICOM DB</a>
<div id="toc"><ul><li><a class="toc-href" href="#example queries" title="Example queries">Example queries</a></li><li><a class="toc-href" href="#demo script to bootstrap a dicom database from scan tarballs" title="Demo script to bootstrap a DICOM database from scan tarballs">Demo script to bootstrap a DICOM database from scan tarballs</a></li></ul></div>                  </li>
                  <li>
                    <a href="../../datamanagement/tools/">Tools</a>
                  </li>
                </ul>
              </li>
              <li><a href="../../analysis/">Data Analysis</a></li>
              <li><a href="../../devices/">Acquisition Hardware</a></li>
              <li><a href="../../containers/">Computational Environments</a></li>
              <li><a href="../../contributing/">Contributing</a></li>
      </ul>
    </nav>
    <form class="searchbox" action="../../search.html">
      <input type="text" name="q" id="tipue_search_input" placeholder="Search">
    </form>
    <img src="../../theme/img/cbbs_logo.png" alt="CBBS Logo">
    <img src="../../theme/img/EFRE_logo.png"
         alt="Signets of Saxony-Anhalt and the European Regional Development Fund">
  </aside>

  <main>
    <div id='content'>
<article>
  <header>
    <nav>
      <ul class="breadcrumbs">
        <li><a href="../../">Home</a></li>
        <li> > <a href="../../datamanagement/">Data Management</a></li>
        <li> > Demo: DICOM DB</li>
      </ul>
    </nav>
    <h1>Demo: DICOM DB</h1>
  </header>

  <div>
    <p>DICOM datasets that have been <a class="reference external" href="../../datamanagement/import_dicoms/">imported into a study raw dataset</a> can (additionally) be collected in scanner (or
institution or lab) specific superdatasets. This allows for convenient record
keeping of all relevant MR data acquisitions ever made in a given context.  The
example script at the bottom of this page shows how to bootstrap such a
database.</p>
<p>Such superdatasets are lightweight, as they do not contain actual imaging data,
and can be queried using a flexible language. In the DICOM context it is often
desired to limit the amount of metadata to whole datasets and their image
series. This can be achieved using the following configuration, which only needs
to be put into the top-most dataset, not every DICOM dataset:</p>
<pre class="literal-block">
% cat .datalad/config
[datalad "dataset"]
        id = 349bb81a-1afe-11e8-959f-a0369f7c647e
[datalad "search"]
        index-autofield-documenttype = datasets
        default-mode = autofield
</pre>
<p>With this setup the DataLad <cite>search</cite> command will automatically discover
metadata for any contained image series, and build a search index that can be
queried for values in one or more individual DICOM fields. This allows for a
variety of useful queries.</p>
<div class="section" id="example-queries">
<h2 id="example queries">Example queries<a class="headerlink" href="#example-queries" title="Permalink to this headline"><i class="icon-link"></i></a></h2>
<p>Report scans made on any male patients in a given time span:</p>
<pre class="literal-block">
% datalad search dicom.Series.AcquisitionDate:'[20130410 TO 20140101]' dicom.Series.PatientSex:'M'
search(ok): lin/7t/xx99_2022/dicoms (dataset)
</pre>
<p>Report any scans for a particular subject ID:</p>
<pre class="literal-block">
% datalad search 'xx99*'
[INFO   ] Query completed in 0.019682836998981657 sec. Reporting up to 20 top matches.
search(ok): lin/7t/xx99_2022/dicoms (dataset)
search(ok): lin/7t/xx99_2014/dicoms (dataset)
search(ok): lin/7t/xx99_2015/dicoms (dataset)
search(ok): lin/3t/xx99_0138/dicoms (dataset)
search(ok): lin/3t/xx99_0139/dicoms (dataset)
search(ok): lin/3t/xx99_0140/dicoms (dataset)
action summary:
  search (ok: 6)
</pre>
<p>For each search hit ALL available metadata is returned. This allows for sophisticated output formating.
Here is an example that reports all studies a particular subject has participated in:</p>
<pre class="literal-block">
% datalad -f '{metadata[dicom][Series][0][StudyDescription]}' search 'xx99*' | uniq
[INFO] Query completed in 0.02244874399912078 sec. Reporting up to 20 top matches.
Studies^Michael_Hanke
transrep2
Transrep2
</pre>
</div>
<div class="section" id="demo-script-to-bootstrap-a-dicom-database-from-scan-tarballs">
<h2 id="demo script to bootstrap a dicom database from scan tarballs">Demo script to bootstrap a DICOM database from scan tarballs<a class="headerlink" href="#demo-script-to-bootstrap-a-dicom-database-from-scan-tarballs" title="Permalink to this headline"><i class="icon-link"></i></a></h2>
<p>The following script shows how a bunch of DICOM tarballs from two different
scanners can be imported into a DataLad superdataset for each scanner. Those
two scanner datasets are than assembled into a joint superdataset for
acquisition hardware of the institution. Metadata from any acquisition session can then
be aggregated into this dataset, to track all acquisitions made on those
devices, as well as to be able to query for individual scan sessions, DICOM
series, or individual DICOM images (see above for query examples).</p>
<div class="highlight"><pre><span></span><span class="c1"># get the tools</span>
datalad install -s https://github.com/psychoinformatics-de/cbbs-imaging-container-import import
datalad get import/cbbs-imaging.simg

<span class="c1"># create a super dataset that will have all acquisitions the 7T ever made</span>
singularity run import/cbbs-imaging.simg create 7t
<span class="nb">cd</span> 7t
<span class="c1"># import a bunch of DICOM tarballs (simulates daily routine)</span>
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/pandora/data/xx99/raw/dicom/xx99_2022.20130410.103515.930000.tar.gz
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/7T_ad/data/xx99/raw/dicom/xx99_2014.20130408.123933.087500.tar.gz
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/7T_ad/data/xx99/raw/dicom/xx99_2015.20130408.140515.147500.tar.gz

<span class="c1"># done for now</span>
<span class="nb">cd</span> ..
<span class="c1"># now the same for 3t</span>
singularity run import/cbbs-imaging.simg create 3t
<span class="nb">cd</span> 3t
<span class="c1"># import a bunch of DICOM tarballs</span>
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/3T_av_et/mri/xx99_0138.20140425.121603.06.tar.gz
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/3T_av_et/mri/xx99_0139.20140425.142752.07.tar.gz
singularity run ../import/cbbs-imaging.simg import <span class="se">\</span>
 /home/data/psyinf/forrest_gump/3T_visloc/mri/xx99_0140.20140425.155736.23.tar.gz

<span class="c1"># done</span>
<span class="nb">cd</span> ..

<span class="c1"># one dataset for the entire institute's scan (could in turn be part of one that also</span>
<span class="c1"># includes other modalities/machines)</span>
<span class="c1"># this first part only needs to be done once</span>
datalad create lin
<span class="nb">cd</span> lin
datalad install -d . -s ../7t
datalad install -d . -s ../3t

<span class="c1"># this second part needs to be done everytime the metadata DB shall be updated</span>
<span class="c1"># get the latest state of the scanner datasets (no heavy stuff is moved around)</span>
datalad update --merge -r
<span class="c1"># aggregate from the aggregated metadata</span>
datalad aggregate-metadata -r
<span class="c1"># ready to search</span>
</pre></div>
</div>

  </div>
</article>
    </div>

    <footer>
      <p><small>
          Acknowledgment: funded by the federal state of Saxony-Anhalt and the "European Regional Development Fund" (ERDF 2014-2020), Project: Center for Behavioral Brain Sciences (CBBS), FKZ: ZS/2016/04/78113
      </small></p>
      <p><small>
        content licensed <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">cc-by-sa</a>
        <span class='break'>—</span> ©2017–2018 Team Brawndo <span class='break'>—</span>
        unless <a rel="license" href='../../copyright.html'>indicated otherwise</a>
      </small></p>
    </footer>
  </main>
</body>
</html>