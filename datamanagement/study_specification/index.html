<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Team Brawndo" />
  <title>CBBS Imaging &ndash; Study Metadata</title>
  <link rel="license" hreflang="en" href="../../copyright.html" />

  <link rel="stylesheet" type="text/css" href="../../theme/css/style.css">
</head>

<body>
  <aside>
    <h1><a href="/">CBBS Imaging</a></h1>
    <nav>
      <ul>

              <li>
                <a href="../../datamanagement/">Data Management</a>

                <ul>
                  <li>
                    <a href="../../datamanagement/study_setup/">Initial Study Setup</a>
                  </li>
                  <li>
                    <a class="active" href="../../datamanagement/study_specification/">Study Metadata</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_dicoms/">DICOM Data</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/import_other/">Non-DICOM Data</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/conversion/">BIDS Conversion</a>
                  </li>
                  <li>
                    <a href="../../datamanagement/tools/">Tools</a>
                  </li>
                </ul>
              </li>
              <li><a href="../../analysis/">Data Analysis</a></li>
              <li><a href="../../devices/">Acquisition Hardware</a></li>
              <li><a href="../../containers/">Computational Environments</a></li>
              <li><a href="../../contributing/">Contributing</a></li>
      </ul>
    </nav>
    <form class="searchbox" action="../../search.html">
      <input type="text" name="q" id="tipue_search_input" placeholder="Search">
    </form>
    <img src="../../theme/img/cbbs_logo.png" alt="CBBS Logo">
    <img src="../../theme/img/EFRE_logo.png"
         alt="Signets of Saxony-Anhalt and the European Regional Development Fund">
  </aside>

  <main>
    <div id='content'>
<article>
  <header>
    <nav>
      <ul class="breadcrumbs">
        <li><a href="../../">Home</a></li>
        <li> > <a href="../../datamanagement/">Data Management</a></li>
        <li> > Study Metadata</li>
      </ul>
    </nav>
    <h1>Study Metadata</h1>
  </header>

  <div>
    <p>The study specification consists of JSON files in the <a class="reference external" href="../../datamanagement/study_setup/">study raw dataset</a> and
provides metadata needed for conversion. The tools provided by datalad-hirni aim
to help to (automatically) create and curate those files and convert a study raw
dataset (or single acquisition) based on them.
Each acquisition in a study raw dataset contains such a file. Its default name
is <cite>studyspec.json</cite> directly underneath the acquisition's directory. It's a
JSON-stream consisting of one dictionary per line. We are referring to those
dictionaries as <cite>snippets</cite>. For any data entity in an acquisition (at least any
that is to be converted) there should be such a snippet. Those snippets are
automatically created when you <a class="reference external" href="../../datamanagement/import_dicoms/">import a DICOM tarball</a>
or <a class="reference external" href="../../datamanagement/import_other/">import other data</a> into your study raw dataset.
However, the automatic creation may be incomplete or even incorrect,
depending on your needs. Therefore those specifications need to be edited
before converting the dataset. Since those files are simple JSON files, you can
change them programmatically, edit them manually with any kind of editor you like
or use datalad-hirni's webUI to do so.</p>
<p>The specification snippets have keys, that are meant to be edited and some
special keys, that are not supposed to be changed, but only to automatically be
set on creation. The editable ones have values that are again a dictionary with
two keys: <cite>value</cite> and <cite>approved</cite>, where <cite>approved</cite> is a flag signalling whether
or not the value is just an automatic guess, that needs to either be confirmed
or changed. This is meant to help curation.</p>
<p>Generally, a snippet for a dicom series looks like this:</p>
<pre class="literal-block">
{"location":"dicoms",
 "type":"dicomseries",
 "uid":"1.3.10.2.1102.5.2.34.18716.201347010933155397510580.0.0.0",
 "dataset_id":"42bc01a0-a6c3-11e8-9a5b-a0389fb56dc0",
 "dataset_refcommit":"a771150f0e15f309212bc83186d893c65f731d9c",
 "comment":{"approved":false,"value":""},
 "subject":{"approved":false,"value":"df37"},
 "anon_subject":{"approved":false,"value":"002"},
 "bids_modality":{"approved":false,"value":"bold"},
 "bids_run":{"approved":false,"value":"01"},
 "bids_session":{"approved":false,"value":null},
 "bids_task":{"approved":true,"value":"001"},
 "description":{"approved":true,"value":"MoCoSeries_DiCo"},
 "id":{"approved":false,"value":9},
 "procedures":[{"procedure-name": {"approved": false, "value": ""},
                "procedure-call": {"approved": false, "value": ""},
                "on-anonymize": {"approved": false, "value": false}
                }]
 "tags":[]
}
</pre>
<p>Note, that the first five entries are aforementioned non-editable fields. They
are created by the import routine for DICOMs and supposed to not be changed.
"location", "type", "dataset_id", "dataset_refcommit" are expected in every
snippet independent on the type of data this specification is about.</p>
<p>"location" is a path to the actual data relative to the specification file
containing this very snippet. It might refer to a single file or a directory.</p>
<p>"comment" is a field with no implications in how this snippet or the data it is
about is dealt with. It is meant to provide a place to put notes regarding the
data or TODOs or whatever you might need in order to finish creating the study
raw dataset and preparing conversion.</p>
<p>All keys starting with <cite>bids_</cite> are referring to the terms used in the BIDS
standard and are used for conversion. Many of those are optional and therefore
can have a value of <cite>null</cite> or not appear in the specification at all. In this
example the values were automatically derived from DICOM metadata (note, that
they are not yet "approved"), most importantly from the DICOM field <cite>ProtocolName</cite>.
For conversion of DICOMS currently supported BIDS keys are:</p>
<ul class="simple">
<li>'bids_session'</li>
<li>'bids_task'</li>
<li>'bids_run'</li>
<li>'bids_modality'</li>
<li>'bids_acquisition'</li>
<li>'bids_scan'</li>
<li>'bids_contrast_enhancement'</li>
<li>'bids_reconstruction_algorithm'</li>
<li>'bids_echo'</li>
<li>'bids_direction'</li>
</ul>
<p>For details on their meaning please refer to the <a class="reference external" href="http://bids.neuroimaging.io/">BIDS standard</a>.</p>
<p>The value of "description" comes from DICOM's <cite>SeriesDescription</cite> and "id" is
prefilled with the value of <cite>SeriesNumber</cite>. It's worth noting, that this "id"
has no technical meaning for datalad-hirni's commands. It is meant to provide
you with a human-readable identification of this DICOM series to ease editing of
the snippet.</p>
<p>"procedures" defines a list of <a class="reference external" href="http://docs.datalad.org/en/latest/generated/man/datalad-run-procedure.html">datalad-procedures</a> to be executed during conversion.
Besides its name such a procedure definition provides the option to overwrite the way it is called ("procedure-call") by passing an alternative format string and a flag to signal whether or not it is to be called only if the conversion with <tt class="docutils literal">datalad <span class="pre">hirni-spec2bids</span></tt> is called with the option <tt class="docutils literal"><span class="pre">--anonymize</span></tt>,
which can be used to apply a defacing routine for example.
An example for such a format string can be found within the <a class="reference external" href="{filename}demo_study.rst">study dataset demo</a>. Such a format string is first and foremost meant to provide arguments to the call for a procedure and the mechanism as provided by datalad itself (see <a class="reference external" href="http://docs.datalad.org/en/latest/generated/man/datalad-run-procedure.html">datalad-procedures</a> for reference) is enhanced by datalad-hirni.
This enhancements makes other fields of the specification snippet available via additional placeholders. Enclose any key of the snippet in double curly brackets and it will be replaced by the value of that key when the procedure is called.
Procedures are available through hirni's toolbox dataset, but can also be provided by yourself. Any datalad-procedure is valid for this specification.
With respect to the example snippet above, note that there is no conversion procedure defined for the dicomseries. This is because of the default routine hirni uses. This is a containerized version of <a class="reference external" href="https://github.com/nipy/heudiconv">heudiconv</a> provided by the toolbox.
The respective procedure is called <cite>hirni-dicom-converter</cite> and is only called once per acquisition. This will convert all the dicomseries within that acquisition. Hence any procedure you add to a particular dicomseries will be called after the conversion and usually there shouldn't be a need to do so.
You can however <em>exclude</em> a dicomseries from conversion by adding the tag <cite>hirni-dicom-converter-ignore</cite> to its specification snippet.
The conversion routine for the dicomseries is specified in an additional snippet (created automatically during <a class="reference external" href="../../datamanagement/import_dicoms/">import</a>) of type <cite>dicomseries:all</cite>.</p>
<p>Similarly, a snippet for a physio file may look like this:</p>
<pre class="literal-block">
{"location":"physio/df37_200Hz_1.txt",
 "type":"physio_file",
 "dataset_id":"42bc01a0-a6c3-11e8-9a5b-a0389fb56dc0",
 "dataset_refcommit":"a771150f0e15f309212bc83186d893c65f731d9c",
 "comment":{"approved":false,"value":""},
 "subject":{"approved":false,"value":"df37"},
 "anon_subject":{"approved":false,"value":"002"},
 "bids_run":{"approved":false,"value":"01"},
 "bids_session":{"approved":false,"value":null},
 "bids_task":{"approved":true,"value":"oneback"},
 "sampling-frequency": {"approved": true, "value": "200Hz"},
 "procedures":[{"procedure-name":{"approved":true,"value":"hirni-physiobox-converter"}}],
}
</pre>
<p>Something like this is typically created when <a class="reference external" href="../../datamanagement/import_other/">importing</a> other data than DICOM files by calling <tt class="docutils literal">datalad <span class="pre">hirni-spec4anything</span></tt>.</p>

  </div>
</article>
    </div>

    <footer>
      <p><small>
          Acknowledgment: funded by the federal state of Saxony-Anhalt and the "European Regional Development Fund" (ERDF 2014-2020), Project: Center for Behavioral Brain Sciences (CBBS), FKZ: ZS/2016/04/78113
      </small></p>
      <p><small>
        content licensed <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">cc-by-sa</a>
        <span class='break'>—</span> ©2017–2018 Team Brawndo <span class='break'>—</span>
        unless <a rel="license" href='../../copyright.html'>indicated otherwise</a>
      </small></p>
    </footer>
  </main>
</body>
</html>